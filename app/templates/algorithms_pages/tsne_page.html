{% extends "algorithm_page.html" %}

{% from '_base_parameters.html' import base_parameters_form %}

{% block algorithm_content %}
<section>
    <h2>Configure T-SNE Parameters</h2>

    <form method="POST" onsubmit="showLoadingSpinner()">
        
        {{ base_parameters_form(column_options, form_data) }}

        <!-- ADVANCED PARAMETERS (START) -->
        <button type="button" onclick="toggleAdvancedParams()">Advanced Parameters &raquo;</button>

        <div id="advanced-params" class="hidden" style="margin-top: 15px; border: 1px solid #ccc; padding: 15px;">
            <h4>Advanced T-SNE Parameters</h4>
            
            <div>
                <label for="perplexity">Perplexity:</label>
                <input type="number" step="any" id="perplexity" name="perplexity" value="{{ form_data.get('perplexity', '30.0') }}" placeholder="5.0 to 50.0">
                <small>(Must be less than the number of samples)</small>
            </div>
            <br>
            <div>
                <label for="learning_rate">Learning Rate:</label>
                <input type="text" id="learning_rate" name="learning_rate" value="{{ form_data.get('learning_rate', 'auto') }}" placeholder="e.g., 200.0 or 'auto'">
            </div>
            <br>
            <div>
                <label for="max_iter">Max Iterations:</label>
                <input type="number" id="max_iter" name="max_iter" value="{{ form_data.get('max_iter', '1000') }}" placeholder="1000">
            </div>
            <br>
            <div>
                <label for="init">Initialization Method:</label>
                <select id="init" name="init">
                    <option value="pca" {% if form_data.get('init', 'pca') == 'pca' %}selected{% endif %}>PCA</option>
                    <option value="random" {% if form_data.get('init') == 'random' %}selected{% endif %}>Random</option>
                </select>
            </div>
            <br>
            <div>
                <label for="random_state">Random State:</label>
                <input type="number" id="random_state" name="random_state" value="{{ form_data.get('random_state', '') }}" placeholder="e.g., 42 (for reproducibility)">
            </div>

            <hr style="margin-top: 20px; margin-bottom: 20px;">
            <h5>Optimization & Metric Parameters (Fine-tuning)</h5>

            <div>
                <label for="early_exaggeration">Early Exaggeration:</label>
                <input type="number" step="any" id="early_exaggeration" name="early_exaggeration" value="{{ form_data.get('early_exaggeration', '12.0') }}">
            </div>
            <br>
            <div>
                <label for="n_iter_without_progress">Iterations Without Progress to Stop:</label>
                <input type="number" id="n_iter_without_progress" name="n_iter_without_progress" value="{{ form_data.get('n_iter_without_progress', '300') }}">
            </div>
            <br>
            <div>
                <label for="method">Method:</label>
                <select id="method" name="method">
                    <option value="barnes_hut" {% if form_data.get('method', 'barnes_hut') == 'barnes_hut' %}selected{% endif %}>Barnes-Hut (Fast Approximation)</option>
                    <option value="exact" {% if form_data.get('method') == 'exact' %}selected{% endif %}>Exact (Slow)</option>
                </select>
            </div>
            <br>
            <div>
                <label for="metric">Distance Metric:</label>
                <select id="metric" name="metric">
                    <option value="euclidean" {% if form_data.get('metric', 'euclidean') == 'euclidean' %}selected{% endif %}>Euclidean</option>
                    <option value="cosine" {% if form_data.get('metric') == 'cosine' %}selected{% endif %}>Cosine</option>
                    <option value="manhattan" {% if form_data.get('metric') == 'manhattan' %}selected{% endif %}>Manhattan</option>
                    <option value="chebyshev" {% if form_data.get('metric') == 'chebyshev' %}selected{% endif %}>Chebyshev</option>
                </select>
            </div>
            <br>
            <div>
                <label for="n_jobs">Parallel Jobs (n_jobs):</label>
                <input type="number" id="n_jobs" name="n_jobs" value="{{ form_data.get('n_jobs', '') }}" placeholder="e.g., -1 for all CPU cores">
            </div>
        </div>
        <!-- ADVANCED PARAMETERS (END) -->

        <hr>

        <button type="submit" id="run-button">Run T-SNE</button>

        {% if param_error %}
            <p style="color: red;">{{ param_error }}</p>
        {% endif %}
    </form>

    <div id="loading-spinner" class="spinner hidden"></div>

    {% include '_results_section.html' %}

</section>

{% if scroll_to_results %}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        scrollToElement('results-anchor');
    });
</script>
{% endif %}

{% endblock %}